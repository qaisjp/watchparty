{"ast":null,"code":"import{jsxs as _jsxs}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import _regeneratorRuntime from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import _inherits from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";import _createSuper from\"/home/runner/work/watchparty/watchparty/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";import React from'react';import{Button,Icon}from'semantic-ui-react';import{formatTimestamp,getColorForStringHex,getDefaultPicture,iceServers}from'../../utils';export var VideoChat=/*#__PURE__*/function(_React$Component){_inherits(VideoChat,_React$Component);var _super=_createSuper(VideoChat);function VideoChat(){var _this;_classCallCheck(this,VideoChat);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_super.call.apply(_super,[this].concat(args));_this.ourStream=void 0;_this.videoRefs={};_this.videoPCs={};_this.socket=_this.props.socket;_this.handleSignal=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(data){var msg,from,pc,answer;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:// Handle messages received from signaling server\nmsg=data.msg;from=data.from;pc=_this.videoPCs[from];console.log('recv',from,data);if(!(msg.ice!==undefined)){_context.next=8;break;}pc.addIceCandidate(new RTCIceCandidate(msg.ice));_context.next=20;break;case 8:if(!(msg.sdp&&msg.sdp.type==='offer')){_context.next=19;break;}_context.next=11;return pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));case 11:_context.next=13;return pc.createAnswer();case 13:answer=_context.sent;_context.next=16;return pc.setLocalDescription(answer);case 16:_this.sendSignal(from,{sdp:pc.localDescription});_context.next=20;break;case 19:if(msg.sdp&&msg.sdp.type==='answer'){pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));}case 20:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}();_this.setupWebRTC=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var black,stream,_navigator,_navigator$mediaDevic;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:// Set up our own video\n// Create default stream\nblack=function black(){var _canvas$getContext;var _ref3=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},_ref3$width=_ref3.width,width=_ref3$width===void 0?640:_ref3$width,_ref3$height=_ref3.height,height=_ref3$height===void 0?480:_ref3$height;var canvas=Object.assign(document.createElement('canvas'),{width:width,height:height});(_canvas$getContext=canvas.getContext('2d'))===null||_canvas$getContext===void 0?void 0:_canvas$getContext.fillRect(0,0,width,height);var stream=canvas.captureStream();return Object.assign(stream.getVideoTracks()[0],{enabled:false});};stream=new MediaStream([black()]);_context2.prev=2;_context2.next=5;return(_navigator=navigator)===null||_navigator===void 0?void 0:(_navigator$mediaDevic=_navigator.mediaDevices)===null||_navigator$mediaDevic===void 0?void 0:_navigator$mediaDevic.getUserMedia({audio:true,video:true});case 5:stream=_context2.sent;_context2.next=11;break;case 8:_context2.prev=8;_context2.t0=_context2[\"catch\"](2);console.warn(_context2.t0);case 11:_this.ourStream=stream;// alert server we've joined video chat\n_this.socket.emit('CMD:joinVideo');case 13:case\"end\":return _context2.stop();}}},_callee2,null,[[2,8]]);}));_this.stopWebRTC=function(){_this.ourStream&&_this.ourStream.getTracks().forEach(function(track){track.stop();});_this.ourStream=undefined;Object.keys(_this.videoPCs).forEach(function(key){_this.videoPCs[key].close();delete _this.videoPCs[key];});_this.socket.emit('CMD:leaveVideo');};_this.toggleVideoWebRTC=function(){if(_this.ourStream&&_this.ourStream.getVideoTracks()[0]){var _this$ourStream$getVi;_this.ourStream.getVideoTracks()[0].enabled=!((_this$ourStream$getVi=_this.ourStream.getVideoTracks()[0])===null||_this$ourStream$getVi===void 0?void 0:_this$ourStream$getVi.enabled);}};_this.getVideoWebRTC=function(){var _this$ourStream$getVi2;return _this.ourStream&&((_this$ourStream$getVi2=_this.ourStream.getVideoTracks()[0])===null||_this$ourStream$getVi2===void 0?void 0:_this$ourStream$getVi2.enabled);};_this.toggleAudioWebRTC=function(){if(_this.ourStream&&_this.ourStream.getAudioTracks()[0]){var _this$ourStream$getAu;_this.ourStream.getAudioTracks()[0].enabled=!((_this$ourStream$getAu=_this.ourStream.getAudioTracks()[0])===null||_this$ourStream$getAu===void 0?void 0:_this$ourStream$getAu.enabled);}};_this.getAudioWebRTC=function(){return _this.ourStream&&_this.ourStream.getAudioTracks()[0]&&_this.ourStream.getAudioTracks()[0].enabled;};_this.updateWebRTC=function(){if(!_this.ourStream){// We haven't started video chat, exit\nreturn;}_this.props.participants.forEach(function(user){var id=user.id;if(!user.isVideoChat&&_this.videoPCs[id]){// User isn't in video chat but we have a connection, close it\n_this.videoPCs[id].close();delete _this.videoPCs[id];}if(!user.isVideoChat||_this.videoPCs[id]){// User isn't in video chat, or we already have a connection to them\nreturn;}if(id===_this.socket.id){_this.videoPCs[id]=new RTCPeerConnection();_this.videoRefs[id].srcObject=_this.ourStream;}else{var pc=new RTCPeerConnection({iceServers:iceServers()});_this.videoPCs[id]=pc;// Add our own video as outgoing stream\n//@ts-ignore\npc.addStream(_this.ourStream);pc.onicecandidate=function(event){// We generated an ICE candidate, send it to peer\nif(event.candidate){_this.sendSignal(id,{ice:event.candidate});}};//@ts-ignore\npc.onaddstream=function(event){// Mount the stream from peer\nvar stream=event.stream;// console.log(stream);\n_this.videoRefs[id].srcObject=stream;};// For each pair, have the lexicographically smaller ID be the offerer\nvar isOfferer=_this.socket.id<id;if(isOfferer){pc.onnegotiationneeded=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var offer;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return pc.createOffer();case 2:offer=_context3.sent;_context3.next=5;return pc.setLocalDescription(offer);case 5:_this.sendSignal(id,{sdp:pc.localDescription});case 6:case\"end\":return _context3.stop();}}},_callee3);}));}}});};_this.sendSignal=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(to,data){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:console.log('send',to,data);_this.socket.emit('signal',{to:to,msg:data});case 2:case\"end\":return _context4.stop();}}},_callee4);}));return function(_x2,_x3){return _ref5.apply(this,arguments);};}();return _this;}_createClass(VideoChat,[{key:\"componentDidMount\",value:function componentDidMount(){this.socket.on('signal',this.handleSignal);}},{key:\"componentWillUnmount\",value:function componentWillUnmount(){this.socket.off('signal',this.handleSignal);}},{key:\"componentDidUpdate\",value:function componentDidUpdate(prevProps){if(this.props.rosterUpdateTS!==prevProps.rosterUpdateTS){this.updateWebRTC();}}},{key:\"render\",value:function render(){var _this2=this;var _this$props=this.props,participants=_this$props.participants,pictureMap=_this$props.pictureMap,nameMap=_this$props.nameMap,tsMap=_this$props.tsMap,socket=_this$props.socket;var videoChatContentStyle={height:participants.length<3?220:110,borderRadius:'4px',objectFit:'contain'};return/*#__PURE__*/_jsxs(\"div\",{style:{display:this.props.hide?'none':'flex',width:'100%',flexDirection:'column',overflow:'auto'},children:[!this.ourStream&&/*#__PURE__*/_jsx(\"div\",{style:{display:'flex',flexWrap:'wrap',marginTop:'8px'},children:/*#__PURE__*/_jsxs(Button,{fluid:true,title:\"Join Video Chat\",color:'purple',size:\"medium\",icon:true,labelPosition:\"left\",onClick:this.setupWebRTC,children:[/*#__PURE__*/_jsx(Icon,{name:\"video\"}),\"Join Video Chat\"]})}),this.ourStream&&/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',flexWrap:'wrap'},children:[/*#__PURE__*/_jsxs(Button,{fluid:true,color:'red',size:\"medium\",icon:true,labelPosition:\"left\",onClick:this.stopWebRTC,children:[/*#__PURE__*/_jsx(Icon,{name:\"external\"}),\"Leave\"]}),/*#__PURE__*/_jsxs(Button,{fluid:true,color:this.getVideoWebRTC()?'green':'red',size:\"medium\",icon:true,labelPosition:\"left\",onClick:this.toggleVideoWebRTC,children:[/*#__PURE__*/_jsx(Icon,{name:\"video\"}),this.getVideoWebRTC()?'On':'Off']}),/*#__PURE__*/_jsxs(Button,{fluid:true,color:this.getAudioWebRTC()?'green':'red',size:\"medium\",icon:true,labelPosition:\"left\",onClick:this.toggleAudioWebRTC,children:[/*#__PURE__*/_jsx(Icon,{name:this.getAudioWebRTC()?'microphone':'microphone slash'}),this.getAudioWebRTC()?'On':'Off']})]}),/*#__PURE__*/_jsx(\"div\",{style:{display:'flex',flexWrap:'wrap',justifyContent:'center',marginTop:'8px'},children:participants.map(function(p){return/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsx(\"div\",{style:{position:'relative'//marginLeft: '4px',\n},children:/*#__PURE__*/_jsxs(\"div\",{children:[_this2.ourStream&&p.isVideoChat?/*#__PURE__*/_jsx(\"video\",{ref:function ref(el){_this2.videoRefs[p.id]=el;},style:videoChatContentStyle,autoPlay:true,muted:p.id===socket.id,\"data-id\":p.id}):/*#__PURE__*/_jsx(\"img\",{style:videoChatContentStyle// broken image: https://ui-avatars.com/api/?name=haidee&background=B03060&size=256&color=ffffff\n,src:pictureMap[p.id]||getDefaultPicture(nameMap[p.id],getColorForStringHex(p.id)),alt:\"\"}),/*#__PURE__*/_jsxs(\"div\",{style:{position:'absolute',bottom:'4px',left:'0px',width:'100%',backgroundColor:'rgba(0,0,0,0)',color:'white',borderRadius:'4px',fontSize:'10px',fontWeight:700,display:'flex'},children:[/*#__PURE__*/_jsxs(\"div\",{title:nameMap[p.id]||p.id,style:{width:'80px',backdropFilter:'brightness(80%)',padding:'4px',textOverflow:'ellipsis',whiteSpace:'nowrap',overflow:'hidden',display:'inline-block'},children:[p.isVideoChat&&/*#__PURE__*/_jsx(Icon,{size:\"small\",name:\"video\"}),nameMap[p.id]||p.id]}),/*#__PURE__*/_jsx(\"div\",{style:{backdropFilter:'brightness(60%)',padding:'4px',flexGrow:1,display:'flex',justifyContent:'center'},children:formatTimestamp(tsMap[p.id]||0)})]})]})})},p.id);})})]});}}]);return VideoChat;}(React.Component);","map":{"version":3,"sources":["/home/runner/work/watchparty/watchparty/src/components/VideoChat/VideoChat.tsx"],"names":["React","Button","Icon","formatTimestamp","getColorForStringHex","getDefaultPicture","iceServers","VideoChat","ourStream","videoRefs","videoPCs","socket","props","handleSignal","data","msg","from","pc","console","log","ice","undefined","addIceCandidate","RTCIceCandidate","sdp","type","setRemoteDescription","RTCSessionDescription","createAnswer","answer","setLocalDescription","sendSignal","localDescription","setupWebRTC","black","width","height","canvas","Object","assign","document","createElement","getContext","fillRect","stream","captureStream","getVideoTracks","enabled","MediaStream","navigator","mediaDevices","getUserMedia","audio","video","warn","emit","stopWebRTC","getTracks","forEach","track","stop","keys","key","close","toggleVideoWebRTC","getVideoWebRTC","toggleAudioWebRTC","getAudioTracks","getAudioWebRTC","updateWebRTC","participants","user","id","isVideoChat","RTCPeerConnection","srcObject","addStream","onicecandidate","event","candidate","onaddstream","isOfferer","onnegotiationneeded","createOffer","offer","to","on","off","prevProps","rosterUpdateTS","pictureMap","nameMap","tsMap","videoChatContentStyle","length","borderRadius","objectFit","display","hide","flexDirection","overflow","flexWrap","marginTop","justifyContent","map","p","position","el","bottom","left","backgroundColor","color","fontSize","fontWeight","backdropFilter","padding","textOverflow","whiteSpace","flexGrow","Component"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { Button, Icon } from 'semantic-ui-react';\n\nimport {\n  formatTimestamp,\n  getColorForStringHex,\n  getDefaultPicture,\n  iceServers,\n} from '../../utils';\n\ninterface VideoChatProps {\n  socket: SocketIOClient.Socket;\n  participants: User[];\n  pictureMap: StringDict;\n  nameMap: StringDict;\n  tsMap: NumberDict;\n  rosterUpdateTS: Number;\n  hide?: boolean;\n}\n\nexport class VideoChat extends React.Component<VideoChatProps> {\n  ourStream?: MediaStream;\n  videoRefs: any = {};\n  videoPCs: PCDict = {};\n  socket = this.props.socket;\n\n  componentDidMount() {\n    this.socket.on('signal', this.handleSignal);\n  }\n\n  componentWillUnmount() {\n    this.socket.off('signal', this.handleSignal);\n  }\n\n  componentDidUpdate(prevProps: VideoChatProps) {\n    if (this.props.rosterUpdateTS !== prevProps.rosterUpdateTS) {\n      this.updateWebRTC();\n    }\n  }\n\n  handleSignal = async (data: any) => {\n    // Handle messages received from signaling server\n    const msg = data.msg;\n    const from = data.from;\n    const pc = this.videoPCs[from];\n    console.log('recv', from, data);\n    if (msg.ice !== undefined) {\n      pc.addIceCandidate(new RTCIceCandidate(msg.ice));\n    } else if (msg.sdp && msg.sdp.type === 'offer') {\n      // console.log('offer');\n      await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));\n      const answer = await pc.createAnswer();\n      await pc.setLocalDescription(answer);\n      this.sendSignal(from, { sdp: pc.localDescription });\n    } else if (msg.sdp && msg.sdp.type === 'answer') {\n      pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));\n    }\n  };\n\n  setupWebRTC = async () => {\n    // Set up our own video\n    // Create default stream\n    let black = ({ width = 640, height = 480 } = {}) => {\n      let canvas: any = Object.assign(document.createElement('canvas'), {\n        width,\n        height,\n      });\n      canvas.getContext('2d')?.fillRect(0, 0, width, height);\n      let stream = canvas.captureStream();\n      return Object.assign(stream.getVideoTracks()[0], { enabled: false });\n    };\n    let stream = new MediaStream([black()]);\n\n    try {\n      stream = await navigator?.mediaDevices?.getUserMedia({\n        audio: true,\n        video: true,\n      });\n    } catch (e) {\n      console.warn(e);\n    }\n    this.ourStream = stream;\n    // alert server we've joined video chat\n    this.socket.emit('CMD:joinVideo');\n  };\n\n  stopWebRTC = () => {\n    this.ourStream &&\n      this.ourStream.getTracks().forEach((track) => {\n        track.stop();\n      });\n    this.ourStream = undefined;\n    Object.keys(this.videoPCs).forEach((key) => {\n      this.videoPCs[key].close();\n      delete this.videoPCs[key];\n    });\n    this.socket.emit('CMD:leaveVideo');\n  };\n\n  toggleVideoWebRTC = () => {\n    if (this.ourStream && this.ourStream.getVideoTracks()[0]) {\n      this.ourStream.getVideoTracks()[0].enabled = !this.ourStream.getVideoTracks()[0]\n        ?.enabled;\n    }\n  };\n\n  getVideoWebRTC = () => {\n    return this.ourStream && this.ourStream.getVideoTracks()[0]?.enabled;\n  };\n\n  toggleAudioWebRTC = () => {\n    if (this.ourStream && this.ourStream.getAudioTracks()[0]) {\n      this.ourStream.getAudioTracks()[0].enabled = !this.ourStream.getAudioTracks()[0]\n        ?.enabled;\n    }\n  };\n\n  getAudioWebRTC = () => {\n    return (\n      this.ourStream &&\n      this.ourStream.getAudioTracks()[0] &&\n      this.ourStream.getAudioTracks()[0].enabled\n    );\n  };\n\n  updateWebRTC = () => {\n    if (!this.ourStream) {\n      // We haven't started video chat, exit\n      return;\n    }\n    this.props.participants.forEach((user) => {\n      const id = user.id;\n      if (!user.isVideoChat && this.videoPCs[id]) {\n        // User isn't in video chat but we have a connection, close it\n        this.videoPCs[id].close();\n        delete this.videoPCs[id];\n      }\n      if (!user.isVideoChat || this.videoPCs[id]) {\n        // User isn't in video chat, or we already have a connection to them\n        return;\n      }\n      if (id === this.socket.id) {\n        this.videoPCs[id] = new RTCPeerConnection();\n        this.videoRefs[id].srcObject = this.ourStream;\n      } else {\n        const pc = new RTCPeerConnection({ iceServers: iceServers() });\n        this.videoPCs[id] = pc;\n        // Add our own video as outgoing stream\n        //@ts-ignore\n        pc.addStream(this.ourStream);\n        pc.onicecandidate = (event) => {\n          // We generated an ICE candidate, send it to peer\n          if (event.candidate) {\n            this.sendSignal(id, { ice: event.candidate });\n          }\n        };\n        //@ts-ignore\n        pc.onaddstream = (event: any) => {\n          // Mount the stream from peer\n          const stream = event.stream;\n          // console.log(stream);\n          this.videoRefs[id].srcObject = stream;\n        };\n        // For each pair, have the lexicographically smaller ID be the offerer\n        const isOfferer = this.socket.id < id;\n        if (isOfferer) {\n          pc.onnegotiationneeded = async () => {\n            // Start connection for peer's video\n            const offer = await pc.createOffer();\n            await pc.setLocalDescription(offer);\n            this.sendSignal(id, { sdp: pc.localDescription });\n          };\n        }\n      }\n    });\n  };\n\n  sendSignal = async (to: string, data: any) => {\n    console.log('send', to, data);\n    this.socket.emit('signal', { to, msg: data });\n  };\n\n  render() {\n    const { participants, pictureMap, nameMap, tsMap, socket } = this.props;\n    const videoChatContentStyle = {\n      height: participants.length < 3 ? 220 : 110,\n      borderRadius: '4px',\n      objectFit: 'contain',\n    };\n    return (\n      <div\n        style={{\n          display: this.props.hide ? 'none' : 'flex',\n          width: '100%',\n          flexDirection: 'column',\n          overflow: 'auto',\n        }}\n      >\n        {!this.ourStream && (\n          <div\n            style={{\n              display: 'flex',\n              flexWrap: 'wrap',\n              marginTop: '8px',\n            }}\n          >\n            <Button\n              fluid\n              title=\"Join Video Chat\"\n              color={'purple'}\n              size=\"medium\"\n              icon\n              labelPosition=\"left\"\n              onClick={this.setupWebRTC}\n            >\n              <Icon name=\"video\" />\n              {`Join Video Chat`}\n            </Button>\n          </div>\n        )}\n        {this.ourStream && (\n          <div\n            style={{\n              display: 'flex',\n              flexWrap: 'wrap',\n            }}\n          >\n            <Button\n              fluid\n              color={'red'}\n              size=\"medium\"\n              icon\n              labelPosition=\"left\"\n              onClick={this.stopWebRTC}\n            >\n              <Icon name=\"external\" />\n              {`Leave`}\n            </Button>\n            <Button\n              fluid\n              color={this.getVideoWebRTC() ? 'green' : 'red'}\n              size=\"medium\"\n              icon\n              labelPosition=\"left\"\n              onClick={this.toggleVideoWebRTC}\n            >\n              <Icon name=\"video\" />\n              {this.getVideoWebRTC() ? 'On' : 'Off'}\n            </Button>\n            <Button\n              fluid\n              color={this.getAudioWebRTC() ? 'green' : 'red'}\n              size=\"medium\"\n              icon\n              labelPosition=\"left\"\n              onClick={this.toggleAudioWebRTC}\n            >\n              <Icon\n                name={this.getAudioWebRTC() ? 'microphone' : 'microphone slash'}\n              />\n              {this.getAudioWebRTC() ? 'On' : 'Off'}\n            </Button>\n          </div>\n        )}\n        <div\n          style={{\n            display: 'flex',\n            flexWrap: 'wrap',\n            justifyContent: 'center',\n            marginTop: '8px',\n          }}\n        >\n          {participants.map((p) => {\n            return (\n              <div key={p.id}>\n                <div\n                  style={{\n                    position: 'relative',\n                    //marginLeft: '4px',\n                  }}\n                >\n                  <div>\n                    {this.ourStream && p.isVideoChat ? (\n                      <video\n                        ref={(el) => {\n                          this.videoRefs[p.id] = el;\n                        }}\n                        style={videoChatContentStyle as any}\n                        autoPlay\n                        muted={p.id === socket.id}\n                        data-id={p.id}\n                      />\n                    ) : (\n                      <img\n                        style={videoChatContentStyle as any}\n                        // broken image: https://ui-avatars.com/api/?name=haidee&background=B03060&size=256&color=ffffff\n                        src={\n                          pictureMap[p.id] ||\n                          getDefaultPicture(\n                            nameMap[p.id],\n                            getColorForStringHex(p.id)\n                          )\n                        }\n                        alt=\"\"\n                      />\n                    )}\n                    <div\n                      style={{\n                        position: 'absolute',\n                        bottom: '4px',\n                        left: '0px',\n                        width: '100%',\n                        backgroundColor: 'rgba(0,0,0,0)',\n                        color: 'white',\n                        borderRadius: '4px',\n                        fontSize: '10px',\n                        fontWeight: 700,\n                        display: 'flex',\n                      }}\n                    >\n                      <div\n                        title={nameMap[p.id] || p.id}\n                        style={{\n                          width: '80px',\n                          backdropFilter: 'brightness(80%)',\n                          padding: '4px',\n                          textOverflow: 'ellipsis',\n                          whiteSpace: 'nowrap',\n                          overflow: 'hidden',\n                          display: 'inline-block',\n                        }}\n                      >\n                        {p.isVideoChat && <Icon size=\"small\" name=\"video\" />}\n                        {nameMap[p.id] || p.id}\n                      </div>\n                      <div\n                        style={{\n                          backdropFilter: 'brightness(60%)',\n                          padding: '4px',\n                          flexGrow: 1,\n                          display: 'flex',\n                          justifyContent: 'center',\n                        }}\n                      >\n                        {formatTimestamp(tsMap[p.id] || 0)}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </div>\n    );\n  }\n}\n"]},"metadata":{},"sourceType":"module"}